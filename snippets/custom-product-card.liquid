{% comment %}
  Custom Product Card — with collection-page mobile tweaks for Dawn
{% endcomment %}

{% liquid
  assign p = card_product | default: product
  assign v = card_variant
  if p == null
    echo '<!-- custom-product-card: no product -->'
  endif

  assign uid = section_id | default: section.id | default: 's'
  
  comment
    If variant is passed, use variant-specific data
  endcomment
  if v
    assign card_id = 'cpc-' | append: p.id | append: '-v-' | append: v.id | append: '-' | append: uid
    assign price_now = v.price
    assign price_was = v.compare_at_price
    assign variant_available = v.available
    if v.featured_image
      assign card_image = v.featured_image
    else
      assign card_image = p.featured_image
    endif
    assign card_title = p.title
    unless v.title contains 'Default'
      assign card_title = p.title | append: ' - ' | append: v.title
    endunless
    assign product_url = p.url | append: '?variant=' | append: v.id
    assign variant_id = v.id
  else
    assign card_id = 'cpc-' | append: p.id | append: '-' | append: uid
    assign price_now = p.price | default: p.price_min
    assign price_was = p.compare_at_price_max
    assign variant_available = true
    assign card_image = p.featured_image
    assign card_title = p.title
    assign product_url = p.url
    assign variant_id = p.variants.first.id
  endif

  if lazy_load == false
    assign loading_value = 'eager'
  else
    assign loading_value = 'lazy'
  endif

  assign has_sale = false
  if price_was and price_was > price_now
    assign has_sale = true
    assign discount_pct = price_was | minus: price_now | times: 100 | divided_by: price_was | round
  endif
%}

{% if request.page_type == 'collection' %}
  {% assign on_collection = true %}
{% else %}
  {% assign on_collection = false %}
{% endif %}

<div class="cpc-card {% if on_collection %}cpc--collection{% endif %}" id="{{ card_id }}">
  <div class="cpc-imgwrap">
    <a href="{{ product_url }}" class="cpc-imglink">
      <img
        class="cpc-img"
        id="{{ card_id }}-img"
        src="{{ card_image | image_url: width: 800 }}"
        alt="{{ card_title | escape }}"
        loading="{{ loading_value }}"
      >
    </a>
    <button class="cpc-wish" type="button" aria-label="Wishlist">♡</button>
  </div>

  <div class="cpc-body">
    <h3 class="cpc-title">{{ card_title }}</h3>

    <form method="post" action="/cart/add" class="cpc-form" id="{{ card_id }}-form">
      <!-- Price -->
      <div class="cpc-price">
        {% if has_sale %}
          <span class="cpc-price-now">
            <span class="money" data-currency-{{ shop.currency }}>{{ price_now | money }}</span>
          </span>
          <span class="cpc-price-was">
            <span class="money" data-currency-{{ shop.currency }}>{{ price_was | money }}</span>
          </span>
        {% else %}
          <span class="cpc-price-now">
            <span class="money" data-currency-{{ shop.currency }}>{{ price_now | money }}</span>
          </span>
        {% endif %}
      </div>

      <!-- Variants -->
      {% unless p.has_only_default_variant %}
        <div class="cpc-variants cpc-variants--inline">
          {% for option in p.options_with_values %}
            {% assign opt_handle = option.name | handleize %}
            {% assign option_name_downcase = option.name | downcase %}
            {% comment %}If showing color variant card, hide color selector but show other options like size{% endcomment %}
            {% if v %}
              {% unless option_name_downcase == 'color' or option_name_downcase == 'colour' %}
                <select
                  id="{{ card_id }}-opt-{{ opt_handle }}"
                  class="cpc-select cpc-select--pill"
                  name="options[{{ option.name }}]"
                  data-option-index="{{ forloop.index0 }}"
                >
                  {% for value in option.values %}
                    <option value="{{ value | escape }}">{{ value }}</option>
                  {% endfor %}
                </select>
              {% endunless %}
            {% else %}
              <select
                id="{{ card_id }}-opt-{{ opt_handle }}"
                class="cpc-select cpc-select--pill"
                name="options[{{ option.name }}]"
                data-option-index="{{ forloop.index0 }}"
              >
                {% for value in option.values %}
                  <option value="{{ value | escape }}">{{ value }}</option>
                {% endfor %}
              </select>
            {% endif %}
          {% endfor %}
        </div>
      {% endunless %}      <input type="hidden" name="id" value="{{ variant_id }}">

      <!-- Buttons -->
      <div class="cpc-actions">
        <button type="submit" name="add" class="cpc-btn cpc-btn--outline" {% if v and variant_available == false %}disabled{% endif %}>{% if v and variant_available == false %}Sold Out{% else %}Add to Cart{% endif %}</button>
        <a class="cpc-btn cpc-btn--solid" id="{{ card_id }}-buynow" href="/cart/{{ variant_id }}:1">Buy Now</a>
      </div>
    </form>
  </div>

  <script type="application/json" id="{{ card_id }}-data">
    {{ p | json }}
  </script>
</div>

<script>
  (() => {
    const card = document.getElementById('{{ card_id }}');
    if (!card) return;
    const form = card.querySelector('.cpc-form');
    const imgEl = card.querySelector('.cpc-img');
    const buyNow = card.querySelector('#{{ card_id }}-buynow');
    const dataTag = card.querySelector('#{{ card_id }}-data');
    if (!dataTag) return;

    const product = JSON.parse(dataTag.textContent);
    const selects = card.querySelectorAll('.cpc-select');

    function syncVariant() {
      if (!selects.length) return;
      const opts = Array.from(selects).map((s) => s.value);
      const variant = product.variants.find((v) => JSON.stringify(v.options) === JSON.stringify(opts));
      if (!variant) return;
      form.querySelector('input[name="id"]').value = variant.id;
      buyNow.setAttribute('href', `/cart/${variant.id}:1`);
      if (variant.featured_image && imgEl) imgEl.src = variant.featured_image.src;
    }
    selects.forEach((s) => s.addEventListener('change', syncVariant));

    // Trigger currency conversion for Buckss/BUCKS or similar apps
    function triggerCurrencyConversion() {
      // Try multiple common currency converter triggers
      if (typeof Currency !== 'undefined' && Currency.convertAll) {
        Currency.convertAll(shopCurrency, jQuery('[name=currencies]').val());
      } else if (typeof BUCKS !== 'undefined' && BUCKS.refresh) {
        BUCKS.refresh();
      } else if (window.currencyConverter && window.currencyConverter.convertAll) {
        window.currencyConverter.convertAll();
      }
    }

    // Trigger conversion after a short delay to ensure converter is loaded
    setTimeout(triggerCurrencyConversion, 100);
    // Also trigger on window load
    window.addEventListener('load', triggerCurrencyConversion);
  })();
</script>

<style>
  /* --- Card Layout --- */
  .cpc-card {
    display: flex;
    flex-direction: column;
    border: 1px solid #e6e6e6;
    border-radius: 14px;
    background: #fff;
    overflow: hidden;
    height: 100%;
  }
  .cpc-imgwrap {
    position: relative;
  }
  .cpc-img {
    width: 100%;
    aspect-ratio: 3/4;
    object-fit: cover;
    display: block;
  }
  .cpc-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #111;
    color: #fff;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .cpc-wish {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #fff;
    border: 0;
    font-size: 18px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  /* --- Content --- */
  .cpc-body {
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex: 1;
  }
  .cpc-title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.3;
    margin: 6px 0 4px;
    min-height: 2.8em;
    overflow: hidden;
  }

  /* --- Price + Variants --- */
  .cpc-price {
    white-space: nowrap;
    margin-bottom: 6px;
  }
  .cpc-price-now {
    font-weight: 600;
    font-size: 14px;
    color: #111;
  }
  .cpc-price-was {
    font-size: 13px;
    margin-left: 6px;
    opacity: 0.6;
    text-decoration: line-through;
  }
  .cpc-variants--inline {
    display: flex;
    gap: 6px;
  }
  .cpc-select {
    padding: 4px 24px 4px 10px;
    font-size: 13px;
    border: 1px solid #ccc;
    border-radius: 999px;
    background: #fff;
    min-width: 70px;
    max-width: 90px;
    appearance: none;
    background-image: linear-gradient(45deg, transparent 50%, #111 50%),
      linear-gradient(135deg, #111 50%, transparent 50%);
    background-position: calc(100% - 15px) center, calc(100% - 10px) center;
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
    cursor: pointer;
  }

  /* --- Buttons --- */
  .cpc-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .cpc-btn {
    flex: 1;
    font-size: 13px;
    padding: 8px 10px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    text-decoration: none;
    border: 1px solid transparent;
    transition: 0.2s ease;
  }
  .cpc-btn--outline {
    background: #fff;
    border-color: #111;
    color: #111;
  }
  .cpc-btn--solid {
    background: #111;
    color: #fff;
  }
  .cpc-btn--outline:hover {
    background: #111;
    color: #fff;
  }
  .cpc-btn--solid:hover {
    opacity: 0.9;
  }

  /* --- Mobile tweaks ONLY for collection page --- */
  @media screen and (max-width: 749px) {
    .template-collection .cpc--collection .cpc-price {
      order: -1;
      width: 100%;
    }
    .template-collection .cpc--collection .cpc-variants {
      width: 100%;
      margin-top: 4px;
    }
    .template-collection .cpc--collection .cpc-actions {
      flex-direction: row !important;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
    }
    .template-collection .cpc--collection .cpc-actions .cpc-btn {
      flex: 1 1 50%;
      text-align: center;
      width: 100%;
    }
  }
  /* === MOBILE COLLECTION PAGE: STACK BUTTONS VERTICALLY === */
  @media screen and (max-width: 749px) {
    /* Stack the buttons vertically */
    .cpc--collection .cpc-actions {
      display: flex !important;
      flex-direction: column !important;
      gap: 8px !important;
      width: 100% !important;
      margin-top: 10px !important;
    }

    .cpc--collection .cpc-actions .cpc-btn {
      width: 100% !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      text-align: center !important;
      padding: 10px 0 !important;
      box-sizing: border-box;
    }

    /* Style consistency */
    .cpc--collection .cpc-btn--outline {
      background: #fff !important;
      border: 1px solid #111 !important;
      color: #111 !important;
    }

    .cpc--collection .cpc-btn--solid {
      background: #111 !important;
      color: #fff !important;
    }

    .cpc--collection .cpc-btn--outline:hover {
      background: #111 !important;
      color: #fff !important;
    }

    .cpc--collection .cpc-btn--solid:hover {
      opacity: 0.9;
    }
  }
</style>
